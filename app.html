
<app>

    <div class="sidebar">
        <div class="filter">
            <input type="text" class="filter-input" placeholder="絞り込み検索" ref="filter" oninput={ update }>
        </div>
        <ul>
            <li each={ getFilterdCoins(markets) } class={ selected: selected } onclick={ toggleCoin }>
                { marketName } { symbol }
            </li>
        </ul>
    </div>
    <main class="main">
        <h2>暗号通貨 日本円換算さん</h2>
        <p>左のリストから保有している通貨を選んで、右の表に保有枚数を入れます<br>
        Poloniex、Bittrex、Kraken、CryptopiaのBTC建て通貨に対応しています。<br>
        <small>※Cryptopiaはよく落ちるのでデータが最新でない場合があります。</small></p>

        <table>
            <thead>
                <tr>
                    <th>取引所</th>
                    <th>通貨</th>
                    <th>売値(Bid)</th>
                    <th>買値(Ask)</th>
                    <th>上昇率(24h)</th>
                    <th>保有枚数</th>
                    <th>小計</th>
                    <th>資産割合</th>
                    <th>削除</th>
                </tr>
            </thead>
            <tbody>
                <tr each={ getSelectedCoins(markets) }>
                    <td>{ marketName }</td>
                    <td>
                        <a if={ url } href="{ url }" target="_blank" rel="noreferrer noopener">{ symbol }</a>
                        <span if={ !url }>{ symbol }</span>
                    </td>
                    <td>{ number_format(bid, 4) }円</td>
                    <td>{ number_format(ask, 4) }円</td>
                    <td><span class="{ plus: change >= 0, minus: change < 0 }">{ number_format(change, 2) }%</td>
                    <td><input type="text" class="balance-input" ref="balance_{ symbol }" value="{ balance }" oninput="{ updateBalance }"></td>
                    <td><span class="subtotal">{ number_format(subtotal) }円</span></td>
                    <td>{ number_format(subtotal / total * 100, 2) }%</td>
                    <td><button onclick={ toggleCoin }>削除</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="6">合計</th>
                    <td colspan="3">{ number_format(total) }円</td>
                </tr>
            </tfoot>
        </table>
    </main>

    <style>
        app {
            color: #333;
            font-size: 14px;
        }

        a {
            color: #4d90fe;
            text-decoration: none;
        }

        a:link:hover {
            text-decoration: underline;
        }

        input[type="text"] {
            height: 32px;
            padding: 0 8px;
            font-size: 16px;
            border: 1px solid #CCC;
        }

        ::-webkit-input-placeholder {
            font-size: 13px;
        }
        ::-moz-placeholder {
            font-size: 13px;
        }
        :-ms-input-placeholder {
            font-size: 13px;
        }

        .sidebar {
            float: left;
            width: 220px;
            height: 100%;
            overflow-y: scroll;
        }

        .filter {
            background: #EEE;
            padding: 8px;
        }

        .filter-input {
            width: 100%;
            border-radius: 22px;
            outline: none;
        }

        .filter-input:focus {
            box-shadow: 0 0 0 1px #4d90fe;
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            border-top: 1px solid #DDD;
        }

        ul li {
            margin: 0;
            padding: 6px 10px;
            border-bottom: 1px solid #DDD;
            cursor: pointer;
        }

        ul li:hover {
            background: #F5F5F5;
        }

        ul li.selected {
            background: #27a2db;
            color: #FFF;
        }

        .main {
            margin-left: 240px;
        }

        h2, p {
            margin: 5px 0;
        }

        table {
            margin: 10px 0;
            border-collapse: collapse;
            width: 100%;
        }

        table th,
        table td {
            padding: 6px 10px;
            border: 1px solid #DDD;
            font-size: 14px;
        }

        table thead th {
            padding: 10px 10px;
            font-weight: normal;
            background: #F5F5F5;
            border-bottom: 1px solid #27a2db;
        }

        table tbody tr:last-child th,
        table tbody tr:last-child td {
            border-bottom: 1px solid #27a2db;
        }

        table tfoot th,
        table tfoot td {
            background: #F5F5F5;
            border-top: 1px solid #27a2db;
        }

        table tfoot th {
            text-align: right;
        }

        table tbody tr:nth-child(even) td input {
            width: 100%;
        }

        button {
            border: none;
            border-radius: 4px;
            background: #27a2db;
            color: #FFF;
            padding: 5px 10px;
            cursor: pointer;
        }

        .plus {
            color: #27892f;
        }

        .plus:before {
            content: '+';
        }

        .minus {
            color: #c02a1d;
        }

        .balance-input {
            width: 100%;
        }
    </style>

    <script>
        this.total = 0;

        function sortBySymbol(a, b) {
            if (a.symbol < b.symbol) {
                return -1;
            } else if (a.symbol > b.symbol) {
                return 1;
            } else {
                return 0;
            }
        }

        function getPoloniexCoins(data, btc_rate) {
            var marketName = 'Poloniex';
            var coins = [];

            for (var itemName in data) {
                if (data.hasOwnProperty(itemName)) {
                    var item = data[itemName];

                    if (!startsWith(itemName, 'BTC_')) {
                        continue;
                    }

                    // BTC_XXX -> XXX
                    symbol = itemName.substr(4);

                    coins.push({
                        marketName: marketName,
                        symbol: symbol,
                        url: 'https://poloniex.com/exchange#' + itemName.toLowerCase(),
                        bid: item.highestBid * btc_rate.bid,
                        ask: item.lowestAsk * btc_rate.ask,
                        change: item.percentChange * 100,
                        balance: null,
                        subtotal: 0,
                        selected: false
                    });
                }
            }

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getBittrexCoins(data, btc_rate) {
            var marketName = 'Bittrex';
            var coins = [];

            data.result.forEach(function (item) {
                if (!startsWith(item.MarketName, 'BTC-')) {
                    return;
                }

                // BTC-XXX -> XXX
                symbol = item.MarketName.substr(4);

                coins.push({
                    marketName: marketName,
                    symbol: symbol,
                    url: 'https://bittrex.com/Market/Index?MarketName=' + item.MarketName,
                    bid: item.Bid * btc_rate.bid,
                    ask: item.Ask * btc_rate.ask,
                    change: (item.Last - item.PrevDay) / item.Last * 100,
                    balance: null,
                    subtotal: 0,
                    selected: false
                });
            });

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getKrakenCoins(data, btc_rate) {
            var marketName = 'Kraken';
            var coins = [];

            for (var itemName in data.result) {
                if (data.result.hasOwnProperty(itemName)) {
                    var item = data.result[itemName];

                    // Unquote
                    itemName = itemName.replace('XX', '##');
                    itemName = itemName.replace('X', '');
                    itemName = itemName.replace('##', 'X');

                    // ZZZXBT -> ZZZ
                    symbol = itemName.slice(0, -3);

                    coins.push({
                        marketName: marketName,
                        symbol: symbol,
                        url: 'https://www.kraken.com/charts',
                        bid: item.b[0] * btc_rate.bid,
                        ask: item.a[0] * btc_rate.ask,
                        change: 0,
                        balance: null,
                        subtotal: 0,
                        selected: false
                    });
                }
            }

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getCryptopiaCoins(data, btc_rate) {
            var marketName = 'Cryptopia';
            var coins = [];

            data.Data.forEach(function (item) {
                // XXX/BTC -> XXX
                symbol = item.Label.slice(0, -4);

                coins.push({
                    marketName: marketName,
                    symbol: symbol,
                    url: 'https://www.cryptopia.co.nz/Exchange/?market=' + item.Label.replace('/', '_'),
                    bid: item.BidPrice * btc_rate.bid,
                    ask: item.AskPrice * btc_rate.ask,
                    change: item.Change,
                    balance: null,
                    subtotal: 0,
                    selected: false
                });
            });

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getStore() {
            var store = localStorage.getItem('store');
            return store ? JSON.parse(store) : {};
        }

        function saveStore(store) {
            localStorage.setItem('store', JSON.stringify(store));
        }

        function restore(markets, store) {
            markets.forEach(function (market) {
                if (store[market.marketName] !== undefined) {
                    market.coins.forEach(function (coin) {
                        if (store[market.marketName][coin.symbol] !== undefined) {
                            coin.selected = true;
                            coin.balance = store[market.marketName][coin.symbol];
                        }
                    });
                }
            });
        }

        function calculateTotal(coins) {
            var total = 0;

            coins.forEach(function (coin) {
                total += coin.subtotal;
            });

            return total;
        }

        // TODO: 通貨の正式名称を検索の対象とする
        this.getFilterdCoins = function (markets) {
            var coins = [];
            var filter = this.refs.filter.value.toUpperCase();

            markets.forEach(function (market) {
                market.coins.forEach(function (coin) {
                    if (!filter || coin.symbol.toUpperCase().indexOf(filter) !== -1) {
                        coins.push(coin);
                    }
                });
            });

            return coins;
        }

        this.getSelectedCoins = function (markets) {
            var coins = [];

            markets.forEach(function (market) {
                market.coins.forEach(function (coin) {
                    if (coin.selected) {
                        // Update individual coins subtotal
                        coin.subtotal = coin.bid * coin.balance;

                        coins.push(coin);
                    }
                });
            });

            // Update assets total
            this.total = calculateTotal(coins);

            return coins;
        }

        this.updateBalance = function (e) {
            var item = e.item;
            var store = getStore();

            item.balance = e.target.value;

            if (store[item.marketName] === undefined) {
                store[item.marketName] = {};
            }
            store[item.marketName][item.symbol] = item.balance;

            saveStore(store);
        }

        this.toggleCoin = function (e) {
            var item = e.item;
            var store = getStore();

            if (item.selected) {
                item.selected = false;
                if (store[item.marketName] !== undefined && store[item.marketName][item.symbol] !== undefined) {
                    delete store[item.marketName][item.symbol];
                }
            } else {
                item.selected = true;
                if (store[item.marketName] === undefined) {
                    store[item.marketName] = {};
                }
                store[item.marketName][item.symbol] = item.balance;
            }

            saveStore(store);
        }

        this.markets = [];
        this.markets.push({
            marketName: 'BitFlyer',
            coins: [{
                marketName: 'BitFlyer',
                symbol: 'BTC',
                url: 'https://bitflyer.jp/ex/Price',
                bid: opts.btc_rate.bid,
                ask: opts.btc_rate.ask,
                change: 0,
                balance: null,
                subtotal: 0,
                selected: false
            }]
        });
        this.markets.push(getPoloniexCoins(opts.poloniex, opts.btc_rate));
        this.markets.push(getBittrexCoins(opts.bittrex, opts.btc_rate));
        this.markets.push(getKrakenCoins(opts.kraken, opts.btc_rate));
        this.markets.push(getCryptopiaCoins(opts.cryptopia, opts.btc_rate));

        restore(this.markets, getStore());
    </script>

</app>
