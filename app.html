
<app>

    <div class="sidebar">
        <ul each={ markets }>
            <li each={ coins } class={ selected: selected } onclick={ toggleCoin }>
                { marketName } { symbol }
            </li>
        </ul>
    </div>
    <main class="main">
        <h2>日本円で見れちゃうやつ</h2>
        <p>左のリストから保有している通貨を選んで、右の表に保有枚数を入れます<br>
        PoloniexとBittrexのBTC建てのみ対応です！</p>

        <table>
            <thead>
                <tr>
                    <th>取引所</th>
                    <th>通貨</th>
                    <th>売値(Bid)</th>
                    <th>買値(Ask)</th>
                    <th>上昇率(24h)</th>
                    <th>保有枚数</th>
                    <th>小計</th>
                    <th>削除</th>
                </tr>
            </thead>
            <tbody>
                <tr each={ getSelectedCoins(markets) }>
                    <td>{ marketName }</td>
                    <td>{ symbol }</td>
                    <td>{ number_format(bid, 4) }円</td>
                    <td>{ number_format(ask, 4) }円</td>
                    <td><span class="{ plus: change >= 0, minus: change < 0 }">{ number_format(change, 2) }%</td>
                    <td><input type="text" ref="balance_{ symbol }" value="{ balance }" oninput="{ updateBalance }"></td>
                    <td><span class="subtotal">{ number_format(getSubtotal(this)) }円</span></td>
                    <td><button onclick={ toggleCoin }>削除</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="6">合計</th>
                    <td>{ number_format(getTotal()) }円</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </main>

    <style>
        app {
            color: #333;
            font-size: 14px;
        }

        .sidebar {
            float: left;
            width: 220px;
            height: 100%;
            overflow-y: scroll;
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            border-top: 1px solid #DDD;
        }

        ul li {
            margin: 0;
            padding: 6px 10px;
            border-bottom: 1px solid #DDD;
            cursor: pointer;
        }

        ul li:hover {
            background: #F5F5F5;
        }

        ul li.selected {
            background: #27a2db;
            color: #FFF;
        }

        .main {
            margin-left: 240px;
        }

        h2, p {
            margin: 10px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        table th,
        table td {
            padding: 6px 10px;
            border: 1px solid #DDD;
            font-size: 14px;
        }

        table thead th {
            padding: 10px 10px;
            font-weight: normal;
            background: #F5F5F5;
            border-bottom: 1px solid #27a2db;
        }

        table tbody tr:last-child th,
        table tbody tr:last-child td {
            border-bottom: 1px solid #27a2db;
        }

        table tfoot th,
        table tfoot td {
            background: #F5F5F5;
            border-top: 1px solid #27a2db;
        }

        table tfoot th {
            text-align: right;
        }

        table tbody tr:nth-child(even) td {
            background: #F5F5F5;
        }

        button {
            border: none;
            border-radius: 4px;
            background: #27a2db;
            color: #FFF;
            padding: 5px 10px;
            cursor: pointer;
        }

        .plus {
            color: #27892f;
        }

        .plus:before {
            content: '+';
        }

        .minus {
            color: #c02a1d;
        }
    </style>

    <script>
        function sortBySymbol(a, b) {
            if (a.symbol < b.symbol) {
                return -1;
            } else if (a.symbol > b.symbol) {
                return 1;
            } else {
                return 0;
            }
        }

        function getPoloniexCoins(data, btc_rate) {
            var marketName = 'Poloniex';
            var coins = [];

            for (var symbol in data) {
                if (data.hasOwnProperty(symbol)) {
                    var item = data[symbol];

                    if (!startsWith(symbol, 'BTC_')) {
                        continue;
                    }

                    // BTC_XXX -> XXX
                    symbol = symbol.substr(4);

                    coins.push({
                        marketName: marketName,
                        symbol: symbol,
                        bid: item.highestBid * btc_rate,
                        ask: item.lowestAsk * btc_rate,
                        change: item.percentChange * 100,
                        balance: null,
                        selected: false
                    });
                }
            }

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getBittrexCoins(data, btc_rate) {
            var marketName = 'Bittrex';
            var coins = [];

            data.result.forEach(function (item) {
                if (!startsWith(item.MarketName, 'BTC-')) {
                    return;
                }

                // BTC-XXX -> XXX
                symbol = item.MarketName.substr(4);

                coins.push({
                    marketName: marketName,
                    symbol: symbol,
                    bid: item.Bid * btc_rate,
                    ask: item.Ask * btc_rate,
                    change: (item.Last - item.PrevDay) / item.Last * 100,
                    balance: null,
                    selected: false
                });
            });

            return {
                marketName: marketName,
                coins: coins.sort(sortBySymbol)
            };
        }

        function getStore() {
            var store = localStorage.getItem('store');
            return store ? JSON.parse(store) : {};
        }

        function saveStore(store) {
            localStorage.setItem('store', JSON.stringify(store));
        }

        function restore(markets, store) {
            markets.forEach(function (market) {
                if (store[market.marketName] !== undefined) {
                    market.coins.forEach(function (coin) {
                        if (store[market.marketName][coin.symbol] !== undefined) {
                            coin.selected = true;
                            coin.balance = store[market.marketName][coin.symbol];
                        }
                    });
                }
            });
        }

        this.getSelectedCoins = function (markets) {
            var coins = [];

            markets.forEach(function (market) {
                market.coins.forEach(function (coin) {
                    if (coin.selected) {
                        coins.push(coin);
                    }
                });
            });

            return coins;
        }

        this.updateBalance = function (e) {
            var item = e.item;
            var store = getStore();

            item.balance = e.target.value;

            if (store[item.marketName] === undefined) {
                store[item.marketName] = {};
            }
            store[item.marketName][item.symbol] = item.balance;

            saveStore(store);
        }

        this.toggleCoin = function (e) {
            var item = e.item;
            var store = getStore();

            if (item.selected) {
                item.selected = false;
                if (store[item.marketName] !== undefined && store[item.marketName][item.symbol] !== undefined) {
                    delete store[item.marketName][item.symbol];
                }
            } else {
                item.selected = true;
                console.log(store);
                if (store[item.marketName] === undefined) {
                    store[item.marketName] = {};
                }
                store[item.marketName][item.symbol] = item.balance;
            }

            saveStore(store);
        }

        this.getSubtotal = function (coin) {
            return coin.bid * coin.balance;
        }

        this.getTotal = function () {
            var self = this;
            var coins = this.getSelectedCoins(this.markets);
            var total = 0;

            coins.forEach(function (coin) {
                total += self.getSubtotal(coin);
            });

            return total;
        }

        this.markets = [];
        this.markets.push({
            marketName: 'BitFlyer',
            coins: [{
                marketName: 'BitFlyer',
                symbol: 'BTC',
                bid: opts.btc_rate.bid,
                ask: opts.btc_rate.ask,
                change: 0,
                balance: null,
                selected: false
            }]
        });
        this.markets.push(getPoloniexCoins(opts.poloniex, opts.btc_rate.bid));
        this.markets.push(getBittrexCoins(opts.bittrex, opts.btc_rate.bid));

        restore(this.markets, getStore());
    </script>

</app>
